<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <link rel="stylesheet" href="/static/css/chat.css" /> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <title>Chats</title>
</head>

<style>
    /* General Styles */
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        background-color: #f4f4f4;
    }

    #app-container {
        display: flex;
        width: 100%;
    }

    /* Sidebar for Conversations */
    #conversation-sidebar {
        width: 250px;
        background-color: #333;
        color: white;
        padding: 20px;
        box-sizing: border-box;
    }

    #conversation-sidebar h2 {
        margin-bottom: 10px;
    }

    #conversation-sidebar ul {
        list-style: none;
        padding: 0;
    }

    #conversation-sidebar li {
        padding: 10px;
        cursor: pointer;
        background-color: #444;
        margin-bottom: 5px;
        border-radius: 4px;
    }

    #conversation-sidebar li:hover {
        background-color: #555;
    }

    /* Chat Container */
    #chat-container {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background-color: white;
        padding: 20px;
        box-shadow: -5px 0 10px rgba(0, 0, 0, 0.1);
    }

    #chat-container h2 {
        margin-bottom: 10px;
    }

    #messages {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
    }

    /* Message Styling */
    .message {
        margin-bottom: 10px;
    }

    .message.self {
        text-align: right;
    }

    .message.other {
        text-align: left;
    }

    .message .content {
        display: inline-block;
        max-width: 70%;
        padding: 10px;
        border-radius: 8px;
        background-color: #dfdede;
    }

    .message.self .content {
        background-color: #dcf8c6;
    }

    /* Input Field */
    #message-input {
        width: calc(100% - 85px);
        padding: 10px;
        margin-right: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    button {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }
</style>

<body>

    <div id="app-container">
        <!-- Sidebar for Conversations -->
        <div id="conversation-sidebar">
            <h2>Conversations</h2>
            <ul id="conversation-list">
                <!-- <li onclick="selectConversation('User1', 'User2')">User1 & User2</li>
                <li onclick="selectConversation('User1', 'User3')">User1 & User3</li>
                <li onclick="selectConversation('User2', 'User3')">User2 & User3</li> -->
            </ul>
        </div>

        <!-- Chat Window -->
        <div id="chat-container">
            <h2 id="current-conversation">User1 & User2</h2>
            <div id="messages"></div>
            <input type="text" id="message-input" placeholder="Type your message..." />

            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const socket = new WebSocket("ws://localhost:8228/ws");
        console.log(socket.OPEN)
        const messageInput = document.getElementById("message-input");
        const messagesDiv = document.getElementById("messages");

        // Handle WebSocket connection
        socket.onopen = () => {
            console.log("Connected to WebSocket server");
        };


        socket.onmessage = (event) => {
            const message = JSON.parse(event.data);

            console.log("test")
            // Check if the message belongs to the current conversation
            if (
                (message.sender === currentSender && message.receiver === currentReceiver) ||
                (message.sender === currentReceiver && message.receiver === currentSender)
            ) {
                // addMessage(message.sender, message.content);
            }
        };

        function sendMessage() {

            const user = JSON.parse(messageInput.dataset.user)
            // console.log(JSON.parse(user))

            const message = {

                receiver: user.id,
                // receiver: currentReceiver,
                content: messageInput.value,
            };
            console.log(messageInput.value);
            

            socket.send(JSON.stringify(message));
            messageInput.value = "";
        }

        // fetch users

        function fetchUsers() {
            fetch('/api/contacts')
                .then(response => response.json())
                .then(data => {
                    console.log("Raw API response:", data);

                    // Convert object `{ "aymen": {...}, "user2": {...} }` to array
                    let usersArray = Object.values(data);
                    console.log("Converted users array:", usersArray);

                    if (!Array.isArray(usersArray)) {
                        console.error("API did not return an array:", usersArray);
                        return;
                    }

                    let conversationList = document.getElementById("conversation-list");
                    conversationList.innerHTML = "";

                    usersArray.forEach(user => {
                        let li = document.createElement("li");
                        li.textContent = user.name;
                        li.onclick = () => selectConversation(user);
                        console.log(user);


                        conversationList.appendChild(li);
                    });
                })
                .catch(error => console.error("Error fetching users:", error));
        }

        window.onload = fetchUsers;



        function fetchConversation(receiver) {
            fetch(`/api/chat?receiver=${receiver.id}`)
                .then((response) => response.json())
                .then((data) => {
                    console.log('hello');
                    
                    const msgInput = document.getElementById("message-input")
                    let receiver = JSON.parse(msgInput.dataset.user)

                    messagesDiv.innerHTML = "";
                    data.forEach((msg) => {
                        addMessage(msg, receiver);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                }).catch(console.log);
                
        }

        function selectConversation(receiver) {
            console.log(receiver);

            // currentSender = sender;
            // currentReceiver = receiver;
            document.getElementById("current-conversation").textContent = `${receiver.name}`;
            document.getElementById("message-input").setAttribute('data-user', JSON.stringify(receiver))
            console.log(receiver);

            fetchConversation(receiver);
        }

        function addMessage(msg, currentReceiver) {
            
            const msgElement = document.createElement("div");
            console.log(msg, currentReceiver)

            msgElement.className = `message ${msg.sender !== currentReceiver.id ? "self" : "other"}`;

            const contentElement = document.createElement("div");
            contentElement.className = "content";
            contentElement.textContent = msg.content;

            msgElement.appendChild(contentElement);
            messagesDiv.appendChild(msgElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

        }


        let currentReceiver = document.getElementById("message-input").dataset.user

        // Load initial conversation
        fetchConversation(JSON.parse(currentReceiver));

    </script>

</body>

</html>